---
- name: Install Kubernetes Dashboard in control_plane
  hosts: control_plane
  vars_files:
  - variables.yml
  - secret.yml

  tasks:
  - name: Test Connection
    ping:

  - name: Deploy Kubernetes Dashboard
    shell: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.0/aio/deploy/recommended.yaml

  - name: Create a new service-account named "admin-user"
    shell: |-
      cat <<EOF | kubectl apply -f -
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: admin-user
        namespace: kubernetes-dashboard
      EOF

  - name: Bind role to the new service-account
    shell: |-
      cat <<EOF | kubectl apply -f -
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: admin-user
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
      - kind: ServiceAccount
        name: admin-user
        namespace: kubernetes-dashboard
      EOF

  - name: Bind Kong proxy
    shell: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: kubernetes-dashboard-kong-nodeport
        namespace: kubernetes-dashboard
      spec:
        ports:
        - name: kong-proxy-tls
          nodePort: 32001 # Your desired port
          port: 443
          protocol: TCP
          targetPort: 8443
        selector:
          app.kubernetes.io/component: app
          app.kubernetes.io/instance: kubernetes-dashboard
          app.kubernetes.io/name: kong
        type: NodePort

  - name: Create Token
    command: kubectl -n kubernetes-dashboard create token admin-user
    register: kube_dashboard_token

  - name: Print Token
    debug:
      msg: "{{ kube_dashboard_token.stdout }}"



